---
title: "Analysis of hunting effects on spatial structure of trees with different dispersers"
subtitle: "Model fitting"
author: "Robert Bagchi"
date: "July 30, 2016"
output: html_document
---


```{r global_options, include=FALSE}
options(width=80, digits=3)
```

## 1. Preliminaries

### 1.1 Loading and installing libraries

If you need to install the `ReplicatedPointPatterns` package, you can execute the following code. Note, you need the `devtools` package installed. To excute the code below, set 'eval=FALSE
'
```{r package_install, eval=FALSE}
##devtools::install_github('robertbagchi/ReplicatedPointPatterns')
```


We can then load all the necessary libraries.

```{r loadlibs, warning=FALSE, message=FALSE}
rm(list=ls())
# data organisation
library(abind)
library(reshape)
library(tidyr)
library(dplyr)
library(broom)

## spatial analysis
library(spatstat)
library(ReplicatedPointPatterns)

## plotting
library(ggplot2)
library(cowplot)
library(grid)
library(gtable)
library(ggrepel)
library(ggthemes)

usecluster <- TRUE ## run bootstraps locally (FALSE) or use results from cluster (TRUE)
windsep <- TRUE ## model wind dispersed species separately
```


### 1.2 Define some useful functions for this analysis

* Function that standardises a vector (standardise)
* Function to convert K functions to L functions (K2L)
* Function that takes the output from the model and puts it in a convenient format for plotting (kfunclme2plot)
* Function that plots the BLUEs against distance (plot.kfunctionlme)
* Function that plots the coefficient and confidence intervals from a bootstrap (effectplot.Kfunctionlme)
* Function to extract random effect BLUPs to allow plotting (extractModRanefs)
* Function to extract residuals and covariates for plotting (plotModResids)

```{r convenienceFuncs}
source("PeruConvenienceFunctions.R")

## also some specific functions for this analysis
## FUnctinon to extract results table
extractAnova <-  function(Aobj){
  require(abind)
    statlists <- lapply(Aobj[1:2], function(s)
  {
      st <- do.call('rbind', lapply(s, function(d) d[[1]]))
    rownames(st) <-  sapply(s, function(x) paste(x$dists[1], x$dists[length(x$dists)], sep='-'))
    return(st)
  })
  abind(statlists, along=3)
}
## Function that extracts the number of iterations.
niterFind <- function(x) length(x$anovas[[1]]$dtable$D[[1]]$D.boot)
```


### 1.3 ggplot theme for paper
```{r ggthemedef}
theme_cust <- theme(axis.text = element_text(size=7),
                    axis.title.y=element_text(size=10, face='bold'),
                    plot.margin=unit(c(0.5, 0.3, 0.5, 0 ),  'lines'),
                    strip.background=element_rect(fill='white'),
                    strip.text=element_text(size=8),
                    legend.text=element_text(size=8),
                    legend.title=element_text(size=10),
                    panel.grid.minor=element_blank(),
                    panel.grid.major=element_blank())
```

### 1.4 Load the pre-processed data

We load the data that have been processed in another script. These same data can also be used on the cluster for more extensive simulations.

```{r loaddata}
load(file='../data/data4peruanalysisv7.RData')

## remove species with unknown dispersal
hyperdat.bi.sel.c <- subset(hyperdat.bi.sel, Unkwn !=1) ## Bivariate
hyperdat.uni.sel.c <- subset(hyperdat.uni.sel, Unkwn !=1) ## Univariate

if(windsep){
  hyperdat.bi.sel.c <- subset(hyperdat.bi.sel.c, Abiotic!=1)
  hyperdat.uni.sel.c <- subset(hyperdat.uni.sel.c, Abiotic!=1)
  
  hyperdat.uni.wind <- subset(hyperdat.uni.sel, Abiotic==1)
  hyperdat.bi.wind <- subset(hyperdat.bi.sel, Abiotic==1)
}

```

Set number of iterations for bootstrapping - keep small for trials (takes a long time). The code was run on a HPC for paper
```{r setpars}
nsim <- 999
nsimwind <- 999
rmax ## double check  value set in previous code
```



## 2 Sapling only analysis (for hypothesis 1)

### 2.1 Subset the data

The first part of the analysis only uses the sapling data because the first hypothesis (hunting should increase clustering of large-vertebrate species) should be more apparent in saplings. We first subset the data, and then fit the models. The first model (univariate) looks at sapling neighbours around saplings, the second (bivariate) looks at adult neighbours around saplings.

```{r subsetsaplings}
## First sapling only models
hyperdat.uni.sap <- subset(hyperdat.uni.sel.c, stage=='S')
hyperdat.bi.sap <- subset(hyperdat.bi.sel.c, stage=='S')

if(windsep){
  hyperdat.uni.sap.wind <- subset(hyperdat.uni.wind, stage=='S')
  hyperdat.bi.sap.wind <- subset(hyperdat.bi.wind, stage=='S')
}

```

### 2.2 Univariate sapling-only models

#### 2.2.1 Fit model

We start off with an analysis of recruit-recruit spatail structure

We first fit the model.

```{r unimodel}
## fit the model
sapMod.uni <- lmeHyperframe(hyperdat.uni.sap, 0:rmax,
                         fixed="huntpres*HSD",
                         random="1|site",
                         computeK=FALSE)
```

#### 2.2.2 Model diagnostics

Then we can look at some of the diagnostics using the functions defined in the sourced file, "PeruConvenienceFunctions.R".

```{r diagnostics_sapmoduni, fig.height=8}
## Random effects
siteranefs <- tbl_df(extractModRanefs(sapMod.uni))

siteranefs$hunted <- sitedat$hunted[match(siteranefs$id, sitedat$site)]
siteranefs$huntpres <- sitedat$huntpres[match(siteranefs$id, sitedat$site)]

siteranefs %>% ggplot(aes(x=huntpres, y=value)) + geom_smooth(method='gam', method.args=list(k=5)) + geom_point(aes(col=id)) +
    facet_wrap(~distance, scale='free') + theme_tufte()
## looks pretty good - especially given that there are only 6 sites
siteranefs %>% ggplot(aes(sample=value)) + geom_qq() + 
    facet_wrap(~distance, scale='free') + theme_tufte()

## Residuals
resids.uni <- plotModResids(sapMod.uni) ## can ignore warning
# warning is because there is only a single random effect, but 
## result is suitable for further analysis.

## add data on species names
resids.uni$species <- rep(hyperdat.uni.sap$Spp,length(sapMod.uni))
resids.uni$sp.id <- rep(hyperdat.uni.sap$sp.id, length(sapMod.uni))

## Plot residuals vs. hunting pressure (colour is HSD)
resids.uni %>% ggplot(aes(x=huntpres, y=resid, colour=HSD)) +
  facet_wrap(~distance) + 
  geom_point() + geom_smooth(method='gam', method.args=list(k=4)) +
  theme_bw()
## Plot residuals 
resids.uni %>% ggplot(aes(x=HSD, y=resid, colour=huntpres)) +
  facet_wrap(~distance) + 
  geom_point() + geom_smooth() + 
  theme_bw()
## no real trend here, even if there are some big outliers

## residual K-functions - with species labels to idenify outliers
ggplot(data=resids.uni, aes(x=distance, y=resid, colour=HSD, group=species)) +
       geom_line() +
  geom_label(data=subset(resids.uni, distance ==13), 
                                 aes(label=paste(sp.id, species), x=distance, y=resid), size=3) +
  facet_wrap(~site) + 
   theme_bw()
```
 
Looks pretty good overall. There are some biggish outliers, especially *Matisia cordata* (sp.id 764) at LA, an unidentified myrtac (sp.id 446) at RA and *Pourouma minor* (562) and *Matisia rhombifolia* (411) at TRC. Let us take a look at these species:

```{r outliers}
subset(hyperdat.uni.sap, sp.id %in% c(764, 446, 562, 411), 
       select=c('sp.id', 'Spp', 'N1', 'pname'))
```

These species are generally relatively rare at the sites where they are outliers (see the N1 column), so probably have little effect on the analyisis. 

#### 2.2.3 Calculate confidence intervals

```{r unimodel_confints}
## First make the model matrix
preddat.sap <-  expand.grid(stage=c('S'),
                            huntpres=quantile(sitedat$huntpres, c(0.25, 0.75)),
                            HSD = c(0, 1))

sapform <- update(formula(sapMod.uni[[1]]), NULL~.) ## extract formula (and remove lhs)
modmat.sap <-  model.matrix(sapform, data=preddat.sap) ## make model matrix

## Bootstrapping
sapMod.uni.boot <-  bootstrap.t.CI.lme(sapMod.uni, lin.comb.Ct=modmat.sap, nboot=nsim,
                                       alpha=0.05, ncore=7)

```


### 2.3 Bivariate sapling only models
Next we analyse the adult-recruit distances.

#### 2.3.1 Model fitting

Once again, we first have to fit the model.

```{r bimodel}
## fit the model
sapMod.bi <- lmeHyperframe(hyperdat.bi.sap, 0:rmax,
                         fixed="huntpres*HSD",
                         random="1|site",
                         computeK=FALSE)
```


#### 2.3.2 model diagnostics
Then we can look at some of the diagnostics.

```{r diagnostics_sapmodbi, fig.height=8}
siteranefs <- tbl_df(extractModRanefs(sapMod.bi))

siteranefs$hunted <- sitedat$hunted[match(siteranefs$id, sitedat$site)]
siteranefs$huntpres <- sitedat$huntpres[match(siteranefs$id, sitedat$site)]

siteranefs %>% ggplot(aes(x=huntpres, y=value)) + geom_smooth(method='gam', method.args=list(k=5)) + geom_point(aes(col=id)) +
    facet_wrap(~distance, scale='free') + theme_tufte()

## Appears to be very little variation among sites after accounting for hunting pressure.
siteranefs %>% ggplot(aes(sample=value)) + geom_qq() + 
    facet_wrap(~distance, scale='free') + theme_tufte()

par(mfrow=c(1,1))
plot(as.numeric(names(sapMod.bi)), 
     sapply(sapMod.bi, function(mod){ 
       v <- VarCorr(mod)
       v <- as.numeric(v[, "Variance"])
       vc <- v[1]/sum(v)
       return(vc)
     }), xlab="distance", ylab="Variance proportion")


resids.bi <- plotModResids(sapMod.bi)
## add data on species names
resids.bi$species <- rep(hyperdat.bi.sap$Spp, 15)
resids.bi$sp.id <- rep(hyperdat.bi.sap$sp.id, 15)


resids.bi %>% ggplot(aes(x=huntpres, y=resid, colour=HSD)) +
   facet_wrap(~distance) + 
   geom_point() + geom_smooth(method='gam', method.args=list(k=4)) +
   theme_bw()

resids.bi %>% ggplot(aes(x=HSD, y=resid, colour=huntpres)) +
   facet_wrap(~distance, scale='free') +
   geom_point() + geom_smooth(method='gam', method.args=list(k=4)) +
   theme_bw()
## plotting the residuals with labels to identify the outliers.
ggplot(data=resids.bi, aes(x=distance, y=resid, colour=HSD, group=species)) +
  geom_line() +
  geom_label(aes(label=paste(sp.id, species), x=distance, y=resid), size=3) +
  facet_wrap(~site) + 
   theme_bw()

```


#### 2.3.3 Estimating the confidence intervals

```{r bimodel_confints}

## Can use the model matrix from the univariate analysis
## Bootstrapping
sapMod.bi.boot <-  bootstrap.t.CI.lme(sapMod.bi, lin.comb.Ct=modmat.sap, nboot=nsim,
                                       alpha=0.05, ncore=7)

```



### 2.4 Wind dispersed species
This is only run if the flag for analysing wind dispersed species separately is on.

```{r windunimodel_confints, eval=windsep}
sapMod.uni.wind <- lmeHyperframe(hyperdat.uni.sap.wind, 0:rmax,
                         fixed="huntpres",
                         random="1|site",
                         computeK=FALSE)

sapMod.bi.wind <- lmeHyperframe(hyperdat.bi.sap.wind, 0:rmax,
                         fixed="huntpres",
                         random="1|site",
                         computeK=FALSE)

## First make the model matrix
preddat.sap.wind <-  expand.grid(stage=c('S'),
                            huntpres=quantile(sitedat$huntpres, c(0.25, 0.75))
                            )

sapform.wind <- update(formula(sapMod.uni.wind[[1]]), NULL~.) ## extract formula (and remove lhs)
modmat.sap.wind <-  model.matrix(sapform.wind, data=preddat.sap.wind) ## make model matrix

## Bootstrapping
sapMod.uni.wind.boot <-  bootstrap.t.CI.lme(sapMod.uni.wind, lin.comb.Ct=modmat.sap.wind, 
                                            nboot=nsimwind, alpha=0.05, ncore=7)



sapMod.bi.wind.boot <-  bootstrap.t.CI.lme(sapMod.bi.wind, lin.comb.Ct=modmat.sap.wind, 
                                           nboot=nsimwind, alpha=0.05, ncore=7)


## Quick plot of results
plot_grid(effectplot.Kfunctionlme(sapMod.uni.wind.boot),
          effectplot.Kfunctionlme(sapMod.bi.wind.boot), nrow=2, 
          labels=c('Univariate', 'Bivariate'))

```


### 2.5 Examining coefficients of models

We can plot the coefficients from the models and their confidence intervals using functions defined in the convenience functions code side by side with.

```{r exploring_sapling_model_results}
plot_grid(effectplot.Kfunctionlme(sapMod.uni.boot),
          effectplot.Kfunctionlme(sapMod.bi.boot), 
          labels=c('Univariate', 'Bivariate'))
```

These plots suggest that
1. in the univariate analysis
a. within cohort clustering increases with disperser sensitivity
b. Clustering increases slightly faster with HSD in hunted forests

2. In the bivariate analysis 
a. there is more clustering among high HSD species
b. None of the other predictors seem to explain much variation in clustering (CIs are very wide)


### 2.6 Formal tests of Hypothesis 1

We can use an Anova type analysis

```{r H1hypothesistests, eval=!usecluster}
## extract the relevant data
sapMod.uni1way <- lmeHyperframe(hyperdat.uni.sap, 0:rmax,
                         fixed="huntpres+HSD",
                         random="1|site",
                         computeK=FALSE)
anovaSaps1 <- sapply(c('huntpres', 'HSD'), function(term)
{
    bootstrap.compare.lme(sapMod.uni1way, term=term,
                          dists=list(1:5, 1:10, 1:rmax, 5:10), nboot=nsim, ncore=7)
}, simplify=FALSE)


##interaction term
anovaSaps2 <- 
    bootstrap.compare.lme(sapMod.uni, term="huntpres:HSD",
                          dists=list(1:5, 1:10, 1:rmax, 5:10), nboot=99, ncore=7)

anova.saps.uni<- c(anovaSaps1, "huntpres:HSD" = list(anovaSaps2))

```

We can also run the analysis on a cluster and use the results. Here we use that approach.

```{r load_anova, eval=usecluster}
if(!windsep){
  ## if including wind dispersed species
  load("../results/v7.0/uchc/Peru_v7_1_wayAnovaJuvs_rmax15_nsim999_IncAbiotic1.RData")
  load("../results/v7.0/uchc/Peru_v7_2_wayAnovaSaps_rmax15_nsim999_IncAbiotic15.RData")
  anovaSaps1 <- anovaSaps_noabiotic1
  anovaSaps2 <- anovaSaps_noabiotic2
  ## univariate
  anova.saps.uni.1way <- lapply(anovaSaps1$uni$anovas, function(x) x$dtable)
  names(anova.saps.uni.1way) <- sapply(anovaSaps1$uni$anovas, function(x) x[[1]]$term)
  anova.saps.uni <- c(anova.saps.uni.1way, "huntpres:HSD" = list(anovaSaps2$uni$anovas[[1]]$dtable))

  ## bivariate  
  anova.saps.bi.1way <- 
  lapply(anovaSaps1$bi$anovas, function(x) x$dtable)
  names(anova.saps.bi.1way) <- sapply(anovaSaps1$bi$anovas, function(x) x[[1]]$term)
  anova.saps.bi <- c(anova.saps.bi.1way, "huntpres:HSD" = list(anovaSaps2$bi$anovas[[1]]$dtable))

} else
{
  load("../results/v7.0/bbcsrv3/Peru_v7_1_wayAnovaSaps_rmax15_nsim999_IncAbiotic0.RData")
  load("../results/v7.0/bbcsrv3/Peru_v7_2_wayAnovaSaps_rmax15_nsim999_IncAbiotic0.RData")
  
  anova.saps.uni.1way <-
    lapply(anovaSaps_noabiotic1$uni$anovas, function(x) x$dtable)
  names(anova.saps.uni.1way) <- sapply(anovaSaps_noabiotic1$uni$anovas, function(x) x[[1]]$term)
  anova.saps.uni <- c(anova.saps.uni.1way, "huntpres:HSD" = list(anovaSaps_noabiotic2$uni$anovas[[1]]$dtable))
  
  ## bivariate
  anova.saps.bi.1way <- 
    lapply(anovaSaps_noabiotic1$bi$anovas, function(x) x$dtable)
  names(anova.saps.bi.1way) <- sapply(anovaSaps_noabiotic1$bi$anovas, function(x) x[[1]]$term)
  anova.saps.bi <- c(anova.saps.bi.1way, "huntpres:HSD" = list(anovaSaps_noabiotic2$bi$anovas[[1]]$dtable))
}

```

In either case, we then extract the relevant results 

```{r saplinganovaresults}
## univariate
saplingAnovaTable.uni <- do.call(what='abind', args=list(lapply(anova.saps.uni, extractAnova), 
                                along=2, 
                                new.names=list(NULL,
                                               paste(rep(names(anova.saps.uni), each=2), 
                                                     rep(c('D', 'P'), 3), sep='_'),
                                               NULL)))

## bivariate results
saplingAnovaTable.bi <- do.call(what='abind', args=list(lapply(anova.saps.bi, extractAnova), 
                                along=2, 
                                new.names=list(NULL,
                                               paste(rep(names(anova.saps.bi), each=2), 
                                                     rep(c('D', 'P'), 3), sep='_'),
                                               NULL)))

saplingAnovaTable.uni[,,1]
saplingAnovaTable.bi[,,1]
```

```{r H1windsp, eval=windsep}

## extract the relevant data
## Univariate
anovaSapsWind.uni <- bootstrap.compare.lme(sapMod.uni.wind, term='huntpres',
                          dists=list(1:rmax, 1:5, 6:10, 11:15), nboot=nsimwind, ncore=7)

##Bivariate
anovaSapsWind.bi <- 
    bootstrap.compare.lme(sapMod.bi.wind, term="huntpres",
                          dists=list(1:rmax, 1:5, 6:10, 11:15), nboot=nsimwind, ncore=7)

extractAnova(anovaSapsWind.uni)
extractAnova(anovaSapsWind.bi)
```


## 3 Changes between saplings and juveniles (Hypotheses 2 & 3)


### 3.1 Univariate model

#### 3.1.1 Fit univariate model


```{r univariate_intMod}
## Full model with Juveniles and saplings (pair2)
intMod.uni <- lmeHyperframe(hyperdat.uni.sel.c, 0:rmax,
                         fixed="stage*huntpres*HSD",
                         random="1|site/Spp",
                         computeK=FALSE)

```


#### 3.1.2 Model diagnostics
Checking the model diagnostics

```{r univarIntDiag}
## site level random effects
siteranefs <- tbl_df(extractModRanefs(intMod.uni))

siteranefs$hunted <- sitedat$hunted[match(siteranefs$id, sitedat$site)]
siteranefs$huntpres <- sitedat$huntpres[match(siteranefs$id, sitedat$site)]

siteranefs %>% ggplot(aes(x=huntpres, y=value)) + 
  geom_smooth(method='gam', method.args=list(k=5)) + geom_point(aes(col=id)) +
  facet_wrap(~distance, scale='free') + theme_bw()

siteranefs %>% ggplot(aes(sample=value)) + geom_qq() + 
  facet_wrap(~distance, scale='free') + theme_bw()

## species level random effects
spranefs <- tbl_df(extractModRanefs(intMod.uni, level=2))
spranefs <- separate(spranefs,id, c("site", "Spp"), "/")

spranefs$HSD <- dispersal$HSD[match(spranefs$Spp, dispersal$Spp)]

spranefs %>% ggplot(aes(x=HSD, y=value)) + geom_point() +
  geom_smooth(method='gam', method.args=list(k=5)) + facet_wrap(~site)

spranefs %>% ggplot(aes(sample=value)) + geom_qq() + facet_wrap(~site)

## Certainly not ideal if we were making parametric  - but we 
## are bootstrapping (semi-parametrically) so these aren't too bad. That said,
## perhaps worth looking at some of those LA values
spranefs[spranefs$value > 1500,] ## note - removing this one species had no effect on
##model coeffients.

resids.uni <- plotModResids(intMod.uni)

## add data on species names
dim(resids.uni)
resids.uni$species <- rep(hyperdat.uni.sel.c$Spp, 15)
resids.uni$sp.id <- rep(hyperdat.uni.sel.c$sp.id, 15)
## No particular trends

resids.uni %>% ggplot(aes(x=huntpres, y=resid, colour=HSD)) +
   facet_wrap(~distance) + 
   geom_point() + geom_smooth(method='gam', method.args=list(k=4)) +
   theme_bw()

resids.uni %>% ggplot(aes(x=HSD, y=resid, colour=huntpres)) +
   facet_wrap(~distance, scale='free') +
   geom_point() + geom_smooth(method='gam', method.args=list(k=4)) +
   theme_bw()
## some larger outliers at the high HSD end - looks a little like there is 
## more variation among high HSD species, but this is perhaps not surprising
## given there are more of them.

ggplot(data=resids.uni, aes(x=distance, y=resid, colour=HSD, group=species)) +
       geom_line() +
   geom_label(data=subset(resids.uni, distance ==13), 
                                  aes(label=paste(sp.id, species), x=distance, y=resid), size=3) +
  facet_grid(site~stage) + 
   theme_bw()


siteranefs <- tbl_df(extractModRanefs(intMod.uni))

siteranefs$hunted <- sitedat$hunted[match(siteranefs$id, sitedat$site)]
siteranefs$huntpres <- sitedat$huntpres[match(siteranefs$id, sitedat$site)]

siteranefs %>% ggplot(aes(x=huntpres, y=value)) + 
  geom_smooth(method='gam', method.args=list(k=5)) + geom_point(aes(col=id)) +
    facet_wrap(~distance, scale='free') + theme_bw()
## Still appears to be very little variatioin among sites.

siteranefs %>% ggplot(aes(sample=value)) + geom_qq() + 
    facet_wrap(~distance, scale='free') + theme_bw()


```

### 3.2 Bivariate Model
#### 3.2.1 Fit bivariate model

```{r bivariate_intModel}
## Full models with Juveniles and saplings (pair2)


intMod.bi <- lmeHyperframe(hyperdat.bi.sel.c, 0:rmax,
                         fixed="stage*huntpres*HSD",
                         random="1|site/Spp",
                         computeK=FALSE)
intMod.bi
```

#### 3.2.2 Model diagnostics

Checking the model diagnostics for the interactive bivariate model


```{r fullmodeldiagnostics_bi}
siteranefs <- tbl_df(extractModRanefs(intMod.bi))

siteranefs$hunted <- sitedat$hunted[match(siteranefs$id, sitedat$site)]
siteranefs$huntpres <- sitedat$huntpres[match(siteranefs$id, sitedat$site)]
siteranefs <- na.omit(siteranefs)
siteranefs %>% ggplot(aes(x=huntpres, y=value)) + 
  geom_smooth(method='gam', method.args=list(k=5)) + geom_point(aes(col=id)) +
    facet_wrap(~distance, scale='free') + theme_bw()
## Still appears to be very little variatioin among sites.

siteranefs %>% ggplot(aes(sample=value)) + geom_qq() + 
    facet_wrap(~distance, scale='free') + theme_bw()

## Species random effects
spranefs <- tbl_df(extractModRanefs(intMod.bi, level=2))
spranefs <- separate(spranefs,id, c("site", "Spp"), "/")

spranefs$HSD <- dispersal$HSD[match(spranefs$Spp, dispersal$Spp)]

spranefs %>% ggplot(aes(x=HSD, y=value)) + geom_point() +
  geom_smooth(method='gam', method.args=list(k=5)) + facet_wrap(~site)

spranefs %>% ggplot(aes(sample=value)) + geom_qq() +
  facet_wrap(~site)


resids.bi <- plotModResids(intMod.bi)
## add data on species names

resids.bi$species <- rep(hyperdat.bi.sel.c$Spp, length(unique(resids.bi$distance)))
resids.bi$sp.id <- rep(hyperdat.bi.sel.c$sp.id, length(unique(resids.bi$distance)))
resids.bi$N <- rep(hyperdat.bi.sel.c$N1, length(unique(resids.bi$distance)))


resids.bi %>% ggplot(aes(x=huntpres, y=resid, colour=HSD)) +
   facet_wrap(~distance) + 
   geom_point() + geom_smooth(method='gam', method.args=list(k=4)) +
   theme_bw()

resids.bi %>% ggplot(aes(x=HSD, y=resid, colour=huntpres)) +
   facet_wrap(~distance, scale='free') +
   geom_point() + geom_smooth(method='gam', method.args=list(k=4)) +
   theme_bw()

ggplot(data=resids.bi, aes(x=distance, y=resid, colour=HSD, group=species)) +
       geom_line() +
  geom_label(data=subset(resids.bi, distance ==13), 
                                 aes(label=paste(sp.id, species), x=distance, y=resid), size=3) +
  facet_grid(site~stage) + 
   theme_bw()

```


### 3.3 Wind dispersed species
This is only run if the flag for analysing wind dispersed species separately is on.

```{r windintunimodel, eval=windsep}
intMod.uni.wind <- lmeHyperframe(hyperdat.uni.wind, 0:rmax,
                         fixed="stage*huntpres",
                         random="1|site/Spp",
                         computeK=FALSE)

intMod.bi.wind <- lmeHyperframe(hyperdat.bi.wind, 0:rmax,
                         fixed="stage*huntpres",
                         random="1|site/Spp",
                         computeK=FALSE)

## First make the model matrix
preddat.int.wind <-  expand.grid(stage=c('S', 'J'),
                            huntpres=quantile(sitedat$huntpres, c(0.25, 0.75))
                            )

intform.wind <- update(formula(intMod.uni.wind[[1]]), NULL~.) ## extract formula (and remove lhs)
modmat.int.wind <-  model.matrix(intform.wind, data=preddat.int.wind) ## make model matrix

## Bootstrapping
intMod.uni.wind.boot <-  bootstrap.t.CI.lme(intMod.uni.wind, lin.comb.Ct=modmat.int.wind, 
                                            nboot=nsimwind, alpha=0.05, ncore=7)



intMod.bi.wind.boot <-  bootstrap.t.CI.lme(intMod.bi.wind, lin.comb.Ct=modmat.int.wind, 
                                           nboot=nsimwind, alpha=0.05, ncore=7)

results.wind.int <- list(uni=list(model=intMod.uni.wind, boot=intMod.uni.wind.boot), 
                     bi=list(model=intMod.bi.wind, boot=intMod.bi.wind.boot),
                     nsim=nsimwind)
## Quick plot of results
plot_grid(effectplot.Kfunctionlme(intMod.uni.wind.boot),
          effectplot.Kfunctionlme(intMod.bi.wind.boot), nrow=2)

```

### 3.4 Interactive model confidence intervals

```{r fullmodelboot, eval=!usecluster}
## construct data to make predictions for figures with
preddat.int <-  expand.grid(stage=c('S', 'J'), 
                            huntpres=quantile(sitedat$huntpres, c(0.25, 0.75)),
                            HSD = c(0, 1))
## RHS of model formula
allform <- update(formula(intMod.uni[[1]]), NULL~.)
## Make model matrix
modmat.int <-  model.matrix(allform, data=preddat.int)

## Bootstrapping
## Univariate
system.time(intMod.uni.boot <-  bootstrap.t.CI.lme(intMod.uni, lin.comb.Ct=modmat.int, nboot=nsim,
                                       alpha=0.05, ncore=7))

## bivariate
system.time(intMod.bi.boot <-  bootstrap.t.CI.lme(intMod.bi, lin.comb.Ct=modmat.int, nboot=nsim,
                                                  alpha=0.05, ncore=7))

plot_grid(effectplot.Kfunctionlme(intMod.uni.boot),
          effectplot.Kfunctionlme(intMod.bi.boot), labels=c('Uni', 'bi'))

```


#### 3.4.1 Obtaining the results from the cluster
Once again, we can run the bootstrapping on a cluster and we can use those results here.

```{r clusterresultsJuvs, eval=usecluster}
## Alternatively, load results from cluster
if(windsep)
  load("../results/v7.0/bbcsrv3/PeruDispersal_v7_rmax15_NoAbiotic.RData") else
    load("../results/v7.0/PeruDispersal_v7_rmax15_nsim999.RData")

results$nsim
intMod.uni.boot <- results$uni$boot
intMod.bi.boot <- results$bi$boot
preddat.int <-  results$preddat

clusterNiter <- results$nsim
```

#### 3.4.2 Plotting the coefficients

```{r fullmodelcoefplot}
plot_grid(effectplot.Kfunctionlme(intMod.uni.boot),
          effectplot.Kfunctionlme(intMod.bi.boot), 
          labels=c('Univariate', 'Bivariate'))
```

### 3.5 Formal tests of hypotheses 2 and 3

### 3.5.1 Univariate

The formal anova tests of the full model are very time consuming. It is better to do this on a cluster. First we look at the univariate case

```{r intmodel_anova_uni, eval = !usecluster}
## Main effects
intMod.uni1way <- lmeHyperframe(hyperdat.uni.sel, 0:rmax,
                         fixed="stage + huntpres+HSD",
                         random="1|site/Spp",
                         computeK=FALSE)
anova.int.uni.1way  <- sapply(c('stage', 'huntpres', 'HSD'), function(term)
{
    bootstrap.compare.lme(intMod.uni1way, term=term,
                          dists=list(1:rmax, 1:5, 1:10, 5:10), nboot=nsim, ncore=7)
}, simplify=FALSE)

## 2 way interactions
intMod.uni2way <- lmeHyperframe(hyperdat.uni.sel, 0:rmax,
                         fixed="(stage + huntpres + HSD)^2",
                         random="1|site/Spp",
                         computeK=FALSE)


anova.int.uni.2way <- sapply(c('stage:huntpres', 'stage:HSD', 'huntpres:HSD'), function(term)
{
    bootstrap.compare.lme(intMod.uni2way, term=term,
                          dists=list(1:rmax, 1:5, 1:10, 5:10), nboot=nsim, ncore=7)
}, simplify=FALSE)

## 3-way interaction
anova.int.uni.3way <-
    bootstrap.compare.lme(intMod.uni, term="stage:huntpres:HSD",
                          dists=list(1:rmax, 1:5, 1:10, 5:10), nboot=nsim, ncore=7)

```

### 3.5.2 Bivariate

Then we look at the bivariate case
```{r intmodel_anova_bi, eval = !usecluster}
## Main effects
intMod.bi1way <- lmeHyperframe(hyperdat.bi.sel, 0:rmax,
                         fixed="stage + huntpres+HSD",
                         random="1|site/Spp",
                         computeK=FALSE)

## 2 way interactions
anova.int.bi.1way  <- sapply(c('stage', 'huntpres', 'HSD'), function(term)
{
    bootstrap.compare.lme(intMod.bi1way, term=term,
                          dists=list(1:rmax, 1:5, 1:10, 5:10), nboot=nsim, ncore=7)
}, simplify=FALSE)


intMod.bi2way <- lmeHyperframe(hyperdat.bi.sel, 0:rmax,
                         fixed="(stage + huntpres + HSD)^2",
                         random="1|site/Spp",
                         computeK=FALSE)

## 3-way interaction term
anova.int.bi.2way <- sapply(c('stage:huntpres', 'stage:HSD', 'huntpres:HSD'), function(term)
{
    bootstrap.compare.lme(intMod.bi2way, term=term,
                          dists=list(1:rmax, 1:5, 1:10, 5:10), nboot=nsim, ncore=7)
}, simplify=FALSE)

anova.int.uni.3way <-
    bootstrap.compare.lme(intMod.uni, term="stage:huntpres:HSD",
                          dists=list(1:rmax, 1:5, 1:10, 5:10), nboot=nsim, ncore=7)

```

### 3.5.3 Cluster results
We can load the results from the cluster where a larger number of iterations are possible. 

```{r intModelAnovaClus, eval=usecluster}
if(!windsep)
{
  load("../results/v7.0/bbcsrv3/Peru_v7_1_wayAnovaJuvs_rmax15_nsim999_IncAbiotic1.RData")
  load("../results/v7.0/bbcsrv3/Peru_v7_2_wayAnovaJuvs_rmax15_nsim999_IncAbiotic1.RData")
  load("../results/v7.0/bbcsrv3/Peru_v7_3_wayAnovaJuvs_rmax15_nsim999_IncAbiotic1.RData")
  
  anovaJuvs1 <- anovaJuvs_noabiotic1
  anovaJuvs2 <- anovaJuvs_noabiotic2
  anovaJuvs3 <- anovaJuvs_noabiotic3
  rm(anovaJuvs_noabiotic1, anovaJuvs_noabiotic2, anovaJuvs_noabiotic3)
  
  # univariate
  anova.int.uni.1way <- 
    lapply(anovaJuvs1$uni$anovas, function(x) x$dtable)
  
  names(anova.int.uni.1way) <- sapply(anovaJuvs1$uni$anovas, function(x) x[[1]]$term)
  
  anova.int.uni.2way <- 
    lapply(anovaJuvs2$uni$anovas, function(x) x$dtable)
  
  names(anova.int.uni.2way) <- sapply(anovaJuvs2$uni$anovas, function(x) x[[1]]$term)
  
  anova.int.uni.3way <- list(anovaJuvs3$uni$anovas[[1]]$dtable)
  anova.int.uni <- c(anova.int.uni.1way, anova.int.uni.2way, 
                     "stage:HSD:hunt" = anova.int.uni.3way)
  niterFind(anovaJuvs1$uni)
  niterFind(anovaJuvs2$uni)
  niterFind(anovaJuvs3$uni)
  
  ## bivariate
  anova.int.bi.1way <- 
    lapply(anovaJuvs1$bi, function(x) x$dtable)
  names(anova.int.bi.1way) <- sapply(anovaJuvs1$bi, function(x) x[[1]]$term)
  
  
  anova.int.bi.2way <- 
    lapply(anovaJuvs2$bi, function(x) x$dtable)
  names(anova.int.bi.2way) <- sapply(anovaJuvs2$bi, function(x) x[[1]]$term)
  
  anova.int.bi.3way <- list(anovaJuvs3$bi[[1]]$dtable)
  
  anova.int.bi <- c(anova.int.bi.1way, anova.int.bi.2way, 
                    "stage:HSD:hunt" =anova.int.bi.3way)
  
} else
{
  load("../results/v7.0/bbcsrv3/Peru_v7_1_wayAnovaJuvs_rmax15_nsim999_IncAbiotic0.RData")
  load("../results/v7.0/bbcsrv3/Peru_v7_2_wayAnovaJuvs_rmax15_nsim999_IncAbiotic0.RData")
  load("../results/v7.0/bbcsrv3/Peru_v7_3_wayAnovaJuvs_rmax15_nsim999_IncAbiotic0.RData")
  
    # univariate
  anova.int.uni.1way <- 
    lapply(anovaJuvs_noabiotic1$uni$anovas, function(x) x$dtable)
  
  names(anova.int.uni.1way) <- sapply(anovaJuvs_noabiotic1$uni$anovas, function(x) x[[1]]$term)
  
  anova.int.uni.2way <- 
    lapply(anovaJuvs_noabiotic2$uni$anovas, function(x) x$dtable)
  
  names(anova.int.uni.2way) <- sapply(anovaJuvs_noabiotic2$uni$anovas, function(x) x[[1]]$term)
  
  anova.int.uni.3way <- list(anovaJuvs_noabiotic3$uni$anovas[[1]]$dtable)
  anova.int.uni <- c(anova.int.uni.1way, anova.int.uni.2way, 
                     "stage:HSD:hunt" = anova.int.uni.3way)
  niterFind(anovaJuvs_noabiotic1$uni)
  niterFind(anovaJuvs_noabiotic2$uni)
  niterFind(anovaJuvs_noabiotic3$uni)
  
  ## bivariate
  anova.int.bi.1way <- 
    lapply(anovaJuvs_noabiotic1$bi, function(x) x$dtable)
  names(anova.int.bi.1way) <- sapply(anovaJuvs_noabiotic1$bi, function(x) x[[1]]$term)
  
  
  anova.int.bi.2way <- 
    lapply(anovaJuvs_noabiotic2$bi, function(x) x$dtable)
  names(anova.int.bi.2way) <- sapply(anovaJuvs_noabiotic2$bi, function(x) x[[1]]$term)
  
  anova.int.bi.3way <- list(anovaJuvs_noabiotic3$bi[[1]]$dtable)
  
  anova.int.bi <- c(anova.int.bi.1way, anova.int.bi.2way, 
                    "stage:HSD:hunt" =anova.int.bi.3way)

}


```

Now we can put all the results together in a table.

```{r anovatables_int}
intAnovaTable.uni <- do.call(what='abind', args=list(lapply(anova.int.uni, extractAnova), 
                                along=2, 
                                new.names=list(NULL,
                                               paste(rep(names(anova.int.uni), each=2), 
                                                     rep(c('D', 'P'), 3), sep='_'),
                                               NULL)))

intAnovaTable.bi <- do.call(what='abind', args=list(lapply(anova.int.bi, extractAnova), 
                                along=2, 
                                new.names=list(NULL,
                                               paste(rep(names(anova.int.bi), each=2), 
                                                     rep(c('D', 'P'), 3), sep='_'),
                                               NULL)))

intAnovaTable.uni[,,1]
intAnovaTable.bi[,,1]

```


```{r H23windsp, eval=windsep}

intMod.uni.wind_1 <- lmeHyperframe(hyperdat.uni.wind, 0:rmax,
                         fixed="stage + huntpres",
                         random="1|site/Spp",
                         computeK=FALSE)

intMod.bi.wind_1 <- lmeHyperframe(hyperdat.bi.wind, 0:rmax,
                         fixed="stage + huntpres",
                         random="1|site/Spp",
                         computeK=FALSE)
## Univariate
anovaIntWind.uni_1way <- lapply(c('stage', 'huntpres'), function(term) 
{
  bootstrap.compare.lme(intMod.uni.wind_1, term=term,
                        dists=list(1:rmax, 1:5, 6:10, 11:15), nboot=nsimwind, ncore=7)
})

names(anovaIntWind.uni_1way) <- c('stage', 'huntpres')
anovaIntWind.uni_2way <-bootstrap.compare.lme(intMod.uni.wind, term="stage:huntpres", 
                                              dists=list(1:rmax, 1:5, 6:10, 11:15), 
                                              nboot=nsimwind, ncore=7)

anova.int.wind.uni <- c(anovaIntWind.uni_1way, 
                    "stage:hunt"=list(anovaIntWind.uni_2way))

##Bivariate
anovaIntWind.bi_1way <- lapply(c('stage', 'huntpres'), function(term) 
{
  bootstrap.compare.lme(intMod.bi.wind_1, term=term,
                        dists=list(1:rmax, 1:5, 6:10, 11:15), nboot=nsimwind, ncore=7)
})
names(anovaIntWind.bi_1way) <- c('stage', 'huntpres')

anovaIntWind.bi_2way <-bootstrap.compare.lme(intMod.bi.wind, term="stage:huntpres", 
                                              dists=list(1:rmax, 1:5, 6:10, 11:15), 
                                              nboot=nsimwind, ncore=7)

anova.int.wind.bi <- c(anovaIntWind.bi_1way, 
                        "stage:hunt" =list(anovaIntWind.bi_2way))

intAnovaTable.uni.wind <- do.call(what='abind', args=list(lapply(anova.int.wind.uni, extractAnova), 
                                along=2, 
                                new.names=list(NULL,
                                               paste(rep(names(anova.int.wind.uni), each=2), 
                                                     rep(c('D', 'P'), 3), sep='_'),
                                               NULL)))

intAnovaTable.bi.wind <- do.call(what='abind', args=list(lapply(anova.int.wind.bi, extractAnova), 
                                along=2, 
                                new.names=list(NULL,
                                               paste(rep(names(anova.int.wind.bi), each=2), 
                                                     rep(c('D', 'P'), 3), sep='_'),
                                               NULL)))

intAnovaTable.uni.wind
intAnovaTable.bi.wind
```

```{r fullmodelplotting}
################################################################################
## extract predictions and cis from model output
int.bi.plotdat <- kfunclme2plot(intMod.bi.boot, preddat=preddat.int)
int.uni.plotdat <- kfunclme2plot(intMod.uni.boot, preddat=preddat.int)

names(int.bi.plotdat)[2:4] <- paste(names(int.bi.plotdat)[2:4], 'bi', sep='.')
names(int.uni.plotdat)[2:4] <- paste(names(int.uni.plotdat)[2:4], 'uni', sep='.')
## Combine within and between cohort results
int.plotdat <- merge(int.uni.plotdat, int.bi.plotdat, by=c('distance', 'stage','huntpres', 'HSD'), all=T)

## More reader friendly labels
int.plotdat$stage <- factor(int.plotdat$stage, labels=c('Saplings', 'Juveniles'))
int.plotdat$huntpres <-  factor(int.plotdat$huntpres, labels=c('Low', 'High'))
int.plotdat$HSD <-  factor(int.plotdat$HSD, labels=c('Insensitive', 'Sensitive'))

## stat = identity hardwires the order - fixing so that isn't a problem
int.plotdat <- int.plotdat[order(int.plotdat$distance),]

## Make plots
pl.int.bi <-
    ggplot(int.plotdat, aes(x=distance, y=K.bi, ymin=lcl.bi, ymax=ucl.bi,
                    colour=stage, fill=stage)) +
    geom_ribbon(alpha=0.5, colour=NA) +  geom_line() +
    facet_grid(HSD~  huntpres, scales="free_y") +
    geom_abline(intercept=0, slope=0, linetype='dashed', col='grey') +
    theme_bw() + theme_cust + scale_x_continuous(limits=c(0, 15)) +
    scale_color_brewer(palette='Set1')+ scale_fill_brewer(palette='Pastel1') +
    labs(x='Distance, r, (m)',
         y=expression(paste('[', (hat(K)(r)[con]-hat(K)(r)[het]), ']')),
        color='Cohort', fill='Cohort')

pl.int.uni <- ggplot(int.plotdat, aes(x=distance, y=K.uni, ymin=lcl.uni, ymax=ucl.uni,
                                      colour=stage, fill=stage)) +
    geom_ribbon(alpha=0.5, colour=NA) +  geom_line() +
    facet_grid(HSD~  huntpres) +
    geom_abline(intercept=0, slope=0, linetype='dashed', col='grey') +
    theme_bw() + theme_cust + scale_x_continuous(limits=c(0, 15)) +
    scale_color_brewer(palette='Set1')+ scale_fill_brewer(palette='Pastel1') +
    labs(x='Distance, r, (m)',
         y=expression(paste('[', (hat(K)(r)[con]-hat(K)(r)[het]), ']')),
         color='Cohort', fill='Cohort')

## Format figures (1 and 3)
z.bi <- ggplot_gtable(ggplot_build(pl.int.bi))

##gtable_show_layout(z.bi)
## add a label at the top and side
z.bi <- gtable_add_rows(z.bi, height=unit(z.bi$heights[[3]], 'cm'), pos=2)
z.bi <- gtable_add_cols(z.bi, width=unit(z.bi$widths[[7]], 'cm'), pos=7)
z.bi <- gtable_add_cols(z.bi, width=z.bi$widths[[2]], pos=1)

z.bi <- gtable_add_grob(z.bi,
                     list(rectGrob(gp = gpar(fill=NA, col=NA, lwd=0)),
                          textGrob("Relative conspecific clustering", rot = 90,
                                   gp = gpar(fontsize=12))),
                     t=3, l=2, b=9, r=2, name = paste(runif(2)))

z.bi <- gtable_add_grob(z.bi,
                     list(rectGrob(gp=gpar(fill='grey', col=NA, lwd=0.2)),
                          textGrob("Hunting pressure",
                                   gp = gpar(fontsize=12))),
                     t=3, l=5, b=3, r=7, name = paste(runif(2)))
z.bi <- gtable_add_grob(z.bi,
                     list(rectGrob(gp = gpar(fill='grey', col=NA, lwd=0.2)),
                          textGrob("Disperser sensitivity", rot = -90,
                                   gp = gpar(fontsize=12))),
                     t=5, l=9, b=7, r=9, name = paste(runif(2)))
##ggdraw(z.bi)


## Univariate plot
z.uni <- ggplot_gtable(ggplot_build(pl.int.uni+theme_cust))
##gtable_show_layout(z.uni)
## add a label at the top and side
## extra row
z.uni <- gtable_add_rows(z.uni, height=unit(z.uni$heights[[3]], 'cm'),  pos=2)
## extra column
z.uni <- gtable_add_cols(z.uni, width=unit(z.uni$widths[[7]], 'cm'), pos=7)
z.uni <- gtable_add_cols(z.uni, width=z.uni$widths[[2]], pos=1)

z.uni <- gtable_add_grob(z.uni,
                     list(rectGrob(gp = gpar(fill=NA, col=NA, lwd=0)),
                          textGrob("Relative  conspecific clustering", rot = 90,
                                   gp = gpar(fontsize=12))),
                     t=3, l=2, b=9, r=2, name = paste(runif(2)))

## add hunting pressure label
z.uni <- gtable_add_grob(z.uni,
                         list(rectGrob(gp=gpar(fill='grey', col=NA, lwd=0.2)),
                              textGrob("Hunting pressure",
                                       gp = gpar(fontsize=12))),
                         t=3, l=5, b=3, r=7, name = paste(runif(2)))
## add disperser sensitivity label
z.uni <- gtable_add_grob(z.uni,
                         list(rectGrob(gp = gpar(fill='grey', col=NA, lwd=0.2)),
                              textGrob("Disperser sensitivity", rot = -90,
                                       gp = gpar(fontsize=12))),
                         t=5, l=9, b=7, r=9, name = paste(runif(2)))

ggdraw(z.uni)


## Do not run this unless you want to change figures (and have done at least 999 iterations
## commented out to prevent mistakes

if(clusterNiter >= 999){
  png(file='../../huntingpaper/figures/Figure1_uni.png', width=6, height=4, units='in', res=600)
  ggdraw(z.uni)
  dev.off()
  
  pdf(file='../../huntingpaper/figures/Figure1_uni.pdf', width=6, height=4)
  ggdraw(z.uni)
  dev.off()
  
  png(file='../../huntingpaper/figures/Figure3_bi.png', width=6, height=4, units='in', res=600)
  ggdraw(z.bi)
  dev.off()
  
  pdf(file='../../huntingpaper/figures/Figure3_bi.pdf', width=6, height=4)
  ggdraw(z.bi)
  dev.off()
  
}
```

## 5 Description of data set

Extracing some summaries of the data to report in the paper

Some numbers on number of individuals/species etc etc
```{r descriptive_stats}
##reliance on different dispersers
summary(hyperdat.uni.sel)
disp.list.uni <-  aggregate(cbind(LV, SV, SB, Bat, TR, Wind, Expl) ~Spp, subset(hyperdat.uni.sel.c,
                                                                stage=='S'), unique)

disp.list.bi <-  aggregate(cbind(LV, SV, SB, Bat, TR, Wind, Expl) ~Spp, subset(hyperdat.bi.sel.c,
                                                                stage=='S'), unique)

## Merge data from univariate and bivariate analyses
disp.list <- merge(disp.list.uni, disp.list.bi, by="Spp", all=T, suffix=c('uni', 'bi'))

## calculate number of species in each dispersal group
apply(disp.list[, -1], 2, function(x) sum(x>0, na.rm=T)) ## number dependent to some degree
apply(disp.list[, -1], 2, function(x) sum(x==1, na.rm=T)) ## number totally dependent
apply(disp.list[, -1], 2, function(x) sum(!is.na(x))) ## Total number of vertebrate dispersed species
aggregate(Spp ~ pname, hyperdat.uni.wind, function(x) length(unique(x))) # species per site

32/198; 29/164
131/198; 110/164 ## proportion large vertebrate dispersed

## Number of stems in each life stage.
aggregate(N1 ~ stage, hyperdat.uni.sel.c, sum) ##  univariate analysis
aggregate(N1 ~ stage, hyperdat.bi.sel.c, sum) ## bivariate analysis
aggregate(N2 ~ stage, hyperdat.bi.sel.c,  sum) ## number of adults in bivariate

aggregate(Spp ~ pname, hyperdat.uni.sel.c, function(x) length(unique(x))) # species per site
aggregate(Spp ~ pname, hyperdat.bi.sel.c, function(x) length(unique(x))) # species per site


## Numbers in the abiotically dispersed categories
aggregate(N1 ~ stage, hyperdat.uni.wind, sum) ##  univariate analysis
aggregate(N1 ~ stage, hyperdat.bi.wind, sum) ## bivariate analysis
aggregate(N2 ~ stage, hyperdat.bi.wind,  sum) ## number of adults in bivariate

aggregate(Spp ~ pname, hyperdat.uni.wind, function(x) length(unique(x))) # species per site
aggregate(Spp ~ pname, hyperdat.bi.wind, function(x) length(unique(x))) # species per site

```

